<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel ‚Äî VIPs da Val</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0a0f; --surface: #111118; --surface2: #1a1a24; --surface3: #222230;
  --border: #ffffff0f; --border2: #ffffff18;
  --accent: #f97316; --accent2: #fb923c; --accent-dim: #f9731620;
  --text: #f0f0f5; --text2: #a0a0b0; --muted: #5a5a6e;
  --danger: #ef4444; --success: #22c55e; --warning: #eab308; --info: #3b82f6;
  --sidebar: 260px;
}
body { font-family: 'Syne', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

/* ===== SIDEBAR ===== */
.sidebar {
  width: var(--sidebar); background: var(--surface); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; position: fixed; top: 0; left: 0; height: 100vh;
  z-index: 100; transition: transform .3s cubic-bezier(.16,1,.3,1);
}
.sidebar-header {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}
.sidebar-logo { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
.sidebar-logo .icon { font-size: 28px; }
.sidebar-logo span { color: var(--accent); }
.sidebar-sub { font-size: 11px; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 4px; }

.nav { flex: 1; padding: 16px 12px; overflow-y: auto; }
.nav-section { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 8px 12px 6px; }
.nav-item {
  display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px;
  cursor: pointer; transition: all .15s; color: var(--text2); font-size: 14px; font-weight: 600;
  margin-bottom: 2px; border: 1px solid transparent; text-decoration: none;
}
.nav-item:hover { background: var(--surface2); color: var(--text); }
.nav-item.active { background: var(--accent-dim); color: var(--accent); border-color: #f9731625; }
.nav-item .ni { font-size: 18px; width: 24px; text-align: center; }
.nav-badge { margin-left: auto; background: var(--danger); color: #fff; font-size: 10px; padding: 2px 7px; border-radius: 20px; font-family: 'JetBrains Mono', monospace; }

.sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
.user-info { display: flex; align-items: center; gap: 10px; }
.user-avatar { width: 36px; height: 36px; border-radius: 10px; background: var(--accent-dim); border: 1px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 16px; }
.user-name { font-size: 13px; font-weight: 700; }
.user-role { font-size: 11px; color: var(--muted); }
.btn-logout { margin-left: auto; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px; transition: color .15s; }
.btn-logout:hover { color: var(--danger); }

/* ===== MAIN ===== */
.main { margin-left: var(--sidebar); flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
.topbar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 0 32px; height: 64px; display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 50;
}
.page-title { font-size: 18px; font-weight: 800; }
.topbar-right { display: flex; align-items: center; gap: 12px; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: blink 2s ease-in-out infinite; }
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: .3; } }
.status-text { font-size: 12px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }

.content { padding: 32px; flex: 1; }

/* ===== CARDS ===== */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
.stat-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
  padding: 20px; transition: all .2s;
}
.stat-card:hover { border-color: var(--border2); transform: translateY(-2px); }
.stat-icon { font-size: 24px; margin-bottom: 12px; }
.stat-value { font-size: 28px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
.stat-label { font-size: 12px; color: var(--text2); margin-top: 4px; text-transform: uppercase; letter-spacing: .5px; }
.stat-card.accent { border-color: #f9731625; background: linear-gradient(135deg, #f9731608, var(--surface)); }
.stat-card.accent .stat-value { color: var(--accent); }
.stat-card.success { border-color: #22c55e25; }
.stat-card.success .stat-value { color: var(--success); }
.stat-card.info { border-color: #3b82f625; }
.stat-card.info .stat-value { color: var(--info); }
.stat-card.warning { border-color: #eab30825; }
.stat-card.warning .stat-value { color: var(--warning); }

/* ===== TABLES ===== */
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.section-title { font-size: 16px; font-weight: 700; }
.table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead tr { border-bottom: 1px solid var(--border); }
thead th { padding: 14px 16px; text-align: left; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
tbody tr { border-bottom: 1px solid var(--border); transition: background .15s; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--surface2); }
td { padding: 14px 16px; color: var(--text2); }
td strong { color: var(--text); font-weight: 600; }
.mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; }

/* ===== BADGES ===== */
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
}
.badge-pending { background: #eab30820; color: var(--warning); border: 1px solid #eab30840; }
.badge-approved { background: #3b82f620; color: var(--info); border: 1px solid #3b82f640; }
.badge-delivered { background: #22c55e20; color: var(--success); border: 1px solid #22c55e40; }
.badge-rejected { background: #ef444420; color: var(--danger); border: 1px solid #ef444440; }
.badge-failed { background: #ef444420; color: var(--danger); border: 1px solid #ef444440; }
.badge-sending { background: #f9731620; color: var(--accent); border: 1px solid #f9731640; }
.badge-open { background: #3b82f620; color: var(--info); border: 1px solid #3b82f640; }
.badge-resolved { background: #22c55e20; color: var(--success); border: 1px solid #22c55e40; }
.badge-blocked { background: #ef444420; color: var(--danger); border: 1px solid #ef444440; }
.badge-active { background: #22c55e20; color: var(--success); border: 1px solid #22c55e40; }

/* ===== BUTTONS ===== */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 8px; font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s; border: 1px solid transparent; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent2); transform: translateY(-1px); }
.btn-success { background: #22c55e20; color: var(--success); border-color: #22c55e40; }
.btn-success:hover { background: #22c55e30; }
.btn-danger { background: #ef444420; color: var(--danger); border-color: #ef444440; }
.btn-danger:hover { background: #ef444430; }
.btn-ghost { background: var(--surface2); color: var(--text2); border-color: var(--border); }
.btn-ghost:hover { background: var(--surface3); color: var(--text); }
.btn-sm { padding: 5px 10px; font-size: 12px; }

/* ===== FILTERS ===== */
.filters { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.filter-input, .filter-select {
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
  padding: 9px 14px; color: var(--text); font-family: 'Syne', sans-serif; font-size: 13px;
  outline: none; transition: border-color .15s;
}
.filter-input:focus, .filter-select:focus { border-color: var(--accent); }
.filter-input { min-width: 200px; }
.filter-select option { background: var(--surface2); }

/* ===== PAGINATION ===== */
.pagination { display: flex; align-items: center; gap: 8px; margin-top: 16px; justify-content: center; }
.page-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text2); padding: 7px 12px; border-radius: 8px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 12px; transition: all .15s; }
.page-btn:hover { border-color: var(--accent); color: var(--accent); }
.page-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.page-info { font-size: 12px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }

/* ===== MODAL ===== */
.modal-overlay { position: fixed; inset: 0; background: #00000090; z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.modal-overlay.show { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border2); border-radius: 16px; padding: 32px; width: 100%; max-width: 480px; max-height: 80vh; overflow-y: auto; animation: modalIn .2s cubic-bezier(.16,1,.3,1); }
@keyframes modalIn { from { opacity: 0; transform: scale(.95); } to { opacity: 1; transform: scale(1); } }
.modal-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; }
.form-row { margin-bottom: 16px; }
.form-row label { display: block; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-weight: 600; }
.form-row input, .form-row select, .form-row textarea {
  width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
  padding: 10px 14px; color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 13px; outline: none;
}
.form-row input:focus, .form-row select:focus, .form-row textarea:focus { border-color: var(--accent); }
.form-row textarea { resize: vertical; min-height: 80px; }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

/* ===== LOADING ===== */
.loading { display: flex; align-items: center; justify-content: center; padding: 60px; }
.spinner { width: 32px; height: 32px; border: 3px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state { text-align: center; padding: 60px; color: var(--muted); }
.empty-icon { font-size: 48px; margin-bottom: 12px; }

/* ===== DASHBOARD GRIDS ===== */
.dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px; }
.dash-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; }
.dash-card-title { font-size: 13px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

/* ===== TICKET CHAT ===== */
.ticket-msg { padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; max-width: 85%; font-size: 13px; line-height: 1.5; }
.ticket-msg.user { background: var(--surface2); border: 1px solid var(--border); }
.ticket-msg.admin { background: var(--accent-dim); border: 1px solid #f9731625; margin-left: auto; }
.ticket-msg-meta { font-size: 11px; color: var(--muted); margin-top: 4px; font-family: 'JetBrains Mono', monospace; }

/* ===== BROADCAST ===== */
.broadcast-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
.broadcast-progress { flex: 1; }
.progress-bar { height: 6px; background: var(--surface3); border-radius: 3px; overflow: hidden; margin-top: 8px; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 3px; transition: width .5s; }

/* ===== TOAST ===== */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 999; display: flex; flex-direction: column; gap: 10px; }
.toast { background: var(--surface); border: 1px solid var(--border2); border-radius: 10px; padding: 14px 20px; min-width: 280px; font-size: 13px; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 32px #00000060; animation: toastIn .3s cubic-bezier(.16,1,.3,1); }
@keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
.toast-success { border-color: #22c55e40; }
.toast-error { border-color: #ef444440; }

/* ===== SECTIONS ===== */
.section { display: none; }
.section.active { display: block; animation: fadeIn .3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* ===== PIX KEY ===== */
.pix-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 28px; max-width: 500px; }

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .main { margin-left: 0; }
  .dash-grid { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo"><span class="icon">üî•</span>VIPs da <span>Val</span></div>
    <div class="sidebar-sub">// painel de controle</div>
  </div>

  <nav class="nav">
    <div class="nav-section">Principal</div>
    <div class="nav-item active" data-section="dashboard" onclick="navigate('dashboard', this)">
      <span class="ni">üìä</span> Dashboard
    </div>

    <div class="nav-section">Financeiro</div>
    <div class="nav-item" data-section="transactions" onclick="navigate('transactions', this)">
      <span class="ni">üí≥</span> Transa√ß√µes
      <span class="nav-badge" id="badge-pendentes">0</span>
    </div>
    <div class="nav-item" data-section="failures" onclick="navigate('failures', this)">
      <span class="ni">‚ö†Ô∏è</span> Falhas de Entrega
    </div>

    <div class="nav-section">Cat√°logo</div>
    <div class="nav-item" data-section="products" onclick="navigate('products', this)">
      <span class="ni">üõçÔ∏è</span> Produtos
    </div>
    <div class="nav-item" data-section="groups" onclick="navigate('groups', this)">
      <span class="ni">üë•</span> Grupos VIP
    </div>

    <div class="nav-section">Usu√°rios</div>
    <div class="nav-item" data-section="users" onclick="navigate('users', this)">
      <span class="ni">üë§</span> Usu√°rios
    </div>
    <div class="nav-item" data-section="tickets" onclick="navigate('tickets', this)">
      <span class="ni">üé´</span> Tickets
      <span class="nav-badge" id="badge-tickets">0</span>
    </div>

    <div class="nav-section">Marketing</div>
    <div class="nav-item" data-section="broadcast" onclick="navigate('broadcast', this)">
      <span class="ni">üì¢</span> CastCupom
    </div>

    <div class="nav-section">Configura√ß√µes</div>
    <div class="nav-item" data-section="settings" onclick="navigate('settings', this)">
      <span class="ni">‚öôÔ∏è</span> Configura√ß√µes
    </div>
    <div class="nav-item" data-section="stats" onclick="navigate('stats', this)">
      <span class="ni">üìà</span> Estat√≠sticas
    </div>
  </nav>

  <div class="sidebar-footer">
    <div class="user-info">
      <div class="user-avatar">üëë</div>
      <div>
        <div class="user-name" id="userNameDisplay">Admin</div>
        <div class="user-role">Administrador</div>
      </div>
      <button class="btn-logout" onclick="logout()" title="Sair">‚èª</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="page-title" id="pageTitle">Dashboard</div>
    <div class="topbar-right">
      <div class="status-dot"></div>
      <div class="status-text">online</div>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div id="section-dashboard" class="section active">
      <div class="stats-grid" id="dashStats">
        <div class="loading"><div class="spinner"></div></div>
      </div>
      <div class="dash-grid">
        <div class="dash-card">
          <div class="dash-card-title">‚è±Ô∏è √öltimas Transa√ß√µes</div>
          <div id="recentTx"></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-title">üë§ Novos Usu√°rios</div>
          <div id="recentUsers"></div>
        </div>
      </div>
    </div>

    <!-- TRANSA√á√ïES -->
    <div id="section-transactions" class="section">
      <div class="filters">
        <input class="filter-input" id="txSearch" placeholder="üîç Buscar TXID ou Telegram ID..." oninput="loadTransactions()">
        <select class="filter-select" id="txStatus" onchange="loadTransactions()">
          <option value="all">Todos status</option>
          <option value="pending">Pendentes</option>
          <option value="approved">Aprovados</option>
          <option value="delivered">Entregues</option>
          <option value="rejected">Rejeitados</option>
          <option value="delivery_failed">Falha na Entrega</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="loadTransactions()">üîÑ Atualizar</button>
      </div>
      <div class="table-wrap" id="txTable"><div class="loading"><div class="spinner"></div></div></div>
      <div class="pagination" id="txPagination"></div>
    </div>

    <!-- FALHAS DE ENTREGA -->
    <div id="section-failures" class="section">
      <div class="section-header">
        <div class="section-title">‚ö†Ô∏è Falhas de Entrega</div>
        <button class="btn btn-ghost btn-sm" onclick="loadFailures()">üîÑ Atualizar</button>
      </div>
      <div class="table-wrap" id="failuresTable"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <!-- PRODUTOS -->
    <div id="section-products" class="section">
      <div class="section-header">
        <div class="section-title">üõçÔ∏è Produtos</div>
        <button class="btn btn-primary btn-sm" onclick="openProductModal()">+ Novo Produto</button>
      </div>
      <div class="table-wrap" id="productsTable"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <!-- GRUPOS -->
    <div id="section-groups" class="section">
      <div class="section-header">
        <div class="section-title">üë• Grupos VIP</div>
      </div>
      <div class="table-wrap" id="groupsTable"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <!-- USU√ÅRIOS -->
    <div id="section-users" class="section">
      <div class="filters">
        <input class="filter-input" id="userSearch" placeholder="üîç Nome, username ou Telegram ID..." oninput="loadUsers()">
        <select class="filter-select" id="userBlocked" onchange="loadUsers()">
          <option value="">Todos</option>
          <option value="false">Ativos</option>
          <option value="true">Bloqueados</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="loadUsers()">üîÑ Atualizar</button>
      </div>
      <div class="table-wrap" id="usersTable"><div class="loading"><div class="spinner"></div></div></div>
      <div class="pagination" id="usersPagination"></div>
    </div>

    <!-- TICKETS -->
    <div id="section-tickets" class="section">
      <div class="filters">
        <select class="filter-select" id="ticketStatus" onchange="loadTickets()">
          <option value="all">Todos</option>
          <option value="open">Abertos</option>
          <option value="resolved">Resolvidos</option>
          <option value="closed">Fechados</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="loadTickets()">üîÑ Atualizar</button>
      </div>
      <div class="table-wrap" id="ticketsTable"><div class="loading"><div class="spinner"></div></div></div>
      <div class="pagination" id="ticketsPagination"></div>
    </div>

    <!-- CASTCUPOM -->
    <div id="section-broadcast" class="section">
      <div class="section-header">
        <div class="section-title">üì¢ CastCupom ‚Äî Hist√≥rico de Campanhas</div>
        <button class="btn btn-ghost btn-sm" onclick="loadBroadcast()">üîÑ Atualizar</button>
      </div>
      <div id="broadcastList"><div class="loading"><div class="spinner"></div></div></div>
    </div>

    <!-- CONFIGURA√á√ïES -->
    <div id="section-settings" class="section">
      <div class="section-title" style="margin-bottom:24px">‚öôÔ∏è Configura√ß√µes</div>
      <div class="pix-card">
        <div style="font-size:16px;font-weight:700;margin-bottom:6px">üîë Chave PIX</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:20px">Chave utilizada para receber pagamentos</div>
        <div class="form-row">
          <label>Chave PIX Atual</label>
          <input type="text" id="pixKeyInput" placeholder="Carregando...">
        </div>
        <button class="btn btn-primary" onclick="savePixKey()">üíæ Salvar Chave PIX</button>
      </div>
    </div>

    <!-- ESTAT√çSTICAS -->
    <div id="section-stats" class="section">
      <div class="section-title" style="margin-bottom:24px">üìà Estat√≠sticas</div>
      <div class="dash-grid">
        <div class="dash-card">
          <div class="dash-card-title">üìÖ Vendas por dia (30d)</div>
          <div id="chartByDay" style="font-size:12px;color:var(--text2)"></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-title">üìä Transa√ß√µes por status</div>
          <div id="chartByStatus"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL PRODUTO -->
<div class="modal-overlay" id="modalProduct">
  <div class="modal">
    <div class="modal-title">üõçÔ∏è Novo Produto</div>
    <div class="form-row"><label>ID do Produto</label><input type="text" id="p_id" placeholder="ex: pack_vip_01"></div>
    <div class="form-row"><label>Nome</label><input type="text" id="p_name" placeholder="Nome do produto"></div>
    <div class="form-row"><label>Descri√ß√£o</label><textarea id="p_desc" placeholder="Descri√ß√£o..."></textarea></div>
    <div class="form-row"><label>Pre√ßo (R$)</label><input type="number" id="p_price" placeholder="29.90" step="0.01"></div>
    <div class="form-row"><label>Tipo de Entrega</label>
      <select id="p_type"><option value="link">Link</option><option value="media_pack">Pack de M√≠dia</option><option value="group">Grupo</option></select>
    </div>
    <div class="form-row"><label>URL de Entrega</label><input type="text" id="p_url" placeholder="https://..."></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalProduct')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveProduct()">Criar Produto</button>
    </div>
  </div>
</div>

<!-- MODAL TICKET -->
<div class="modal-overlay" id="modalTicket">
  <div class="modal" style="max-width:560px">
    <div class="modal-title" id="ticketModalTitle">Ticket</div>
    <div id="ticketMessages" style="max-height:300px;overflow-y:auto;margin-bottom:16px"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalTicket')">Fechar</button>
      <button class="btn btn-danger btn-sm" id="btnCloseTicket">‚úì Resolver Ticket</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<script>
const API = '/api/panel/data';
let TOKEN = localStorage.getItem('panel_token') || '';
let txPage = 1, usersPage = 1, ticketsPage = 1;

// ===== AUTH =====
async function checkAuth() {
  if (!TOKEN) return window.location.href = '/login';
  const res = await fetch('/api/panel/auth', { headers: { Authorization: `Bearer ${TOKEN}` } });
  if (!res.ok) { localStorage.removeItem('panel_token'); window.location.href = '/login'; }
  const user = JSON.parse(localStorage.getItem('panel_user') || '{}');
  document.getElementById('userNameDisplay').textContent = user.name || 'Admin';
}

function logout() {
  localStorage.removeItem('panel_token');
  localStorage.removeItem('panel_user');
  window.location.href = '/login';
}

async function api(action, opts = {}) {
  const { method = 'GET', body, params = {} } = opts;
  const qs = new URLSearchParams({ action, ...params }).toString();
  const res = await fetch(`${API}?${qs}`, {
    method,
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${TOKEN}` },
    body: body ? JSON.stringify(body) : undefined
  });
  return res.json();
}

// ===== NAVIGATION =====
const sectionTitles = {
  dashboard: 'Dashboard', transactions: 'Transa√ß√µes', failures: 'Falhas de Entrega',
  products: 'Produtos', groups: 'Grupos VIP', users: 'Usu√°rios',
  tickets: 'Tickets de Suporte', broadcast: 'CastCupom', settings: 'Configura√ß√µes', stats: 'Estat√≠sticas'
};

function navigate(section, el) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`section-${section}`).classList.add('active');
  if (el) el.classList.add('active');
  document.getElementById('pageTitle').textContent = sectionTitles[section] || section;
  const loaders = { dashboard: loadDashboard, transactions: loadTransactions, failures: loadFailures, products: loadProducts, groups: loadGroups, users: loadUsers, tickets: loadTickets, broadcast: loadBroadcast, settings: loadSettings, stats: loadStats };
  if (loaders[section]) loaders[section]();
}

// ===== DASHBOARD =====
async function loadDashboard() {
  const d = await api('dashboard');
  document.getElementById('badge-pendentes').textContent = d.pendentes || 0;
  document.getElementById('badge-tickets').textContent = d.tickets || 0;

  document.getElementById('dashStats').innerHTML = `
    <div class="stat-card accent"><div class="stat-icon">üí∞</div><div class="stat-value">R$ ${fmt(d.totalSales)}</div><div class="stat-label">Receita Total</div></div>
    <div class="stat-card success"><div class="stat-icon">üìà</div><div class="stat-value">R$ ${fmt(d.vendasHoje)}</div><div class="stat-label">Vendas Hoje</div></div>
    <div class="stat-card info"><div class="stat-icon">üìÖ</div><div class="stat-value">R$ ${fmt(d.vendasSemana)}</div><div class="stat-label">Esta Semana</div></div>
    <div class="stat-card warning"><div class="stat-icon">‚è≥</div><div class="stat-value">${d.pendentes}</div><div class="stat-label">Pendentes</div></div>
    <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value">${(d.users||0).toLocaleString()}</div><div class="stat-label">Usu√°rios</div></div>
    <div class="stat-card"><div class="stat-icon">üí≥</div><div class="stat-value">${(d.transactions||0).toLocaleString()}</div><div class="stat-label">Transa√ß√µes</div></div>
    <div class="stat-card"><div class="stat-icon">üé´</div><div class="stat-value">${d.tickets}</div><div class="stat-label">Tickets Abertos</div></div>
    <div class="stat-card"><div class="stat-icon">üì¢</div><div class="stat-value">${d.broadcastAtivo}</div><div class="stat-label">Broadcasts Ativos</div></div>
  `;

  const txHtml = d.recentTx?.map(t => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
      <div><div class="mono" style="color:var(--text)">${t.txid?.substring(0,14)}...</div><div style="font-size:11px;color:var(--muted)">${fmtDate(t.created_at)}</div></div>
      <div style="text-align:right"><div style="font-weight:700;color:var(--accent)">R$ ${fmt(t.amount)}</div><div>${badge(t.status)}</div></div>
    </div>`).join('') || '<div class="empty-state" style="padding:20px">Nenhuma transa√ß√£o</div>';
  document.getElementById('recentTx').innerHTML = txHtml;

  const usersHtml = d.recentUsers?.map(u => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)">
      <div><div style="font-weight:600;color:var(--text)">${u.first_name || 'N/A'}</div><div class="mono" style="font-size:11px;color:var(--muted)">@${u.username || u.telegram_id}</div></div>
      <div style="font-size:11px;color:var(--muted)">${fmtDate(u.created_at)}</div>
    </div>`).join('') || '<div class="empty-state" style="padding:20px">Nenhum usu√°rio</div>';
  document.getElementById('recentUsers').innerHTML = usersHtml;
}

// ===== TRANSA√á√ïES =====
async function loadTransactions() {
  document.getElementById('txTable').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  const search = document.getElementById('txSearch')?.value || '';
  const status = document.getElementById('txStatus')?.value || 'all';
  const d = await api('transactions', { params: { page: txPage, limit: 25, status, search } });
  if (!d.data) return;

  const rows = d.data.map(t => `
    <tr>
      <td><span class="mono">${t.txid?.substring(0,16)}...</span></td>
      <td><span class="mono">${t.telegram_id}</span></td>
      <td><strong>R$ ${fmt(t.amount)}</strong></td>
      <td>${badge(t.status)}</td>
      <td style="color:var(--muted)">${fmtDate(t.created_at)}</td>
      <td>
        ${t.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="approveTransaction('${t.txid}')">‚úì Aprovar</button>
        <button class="btn btn-danger btn-sm" onclick="rejectTransaction('${t.txid}')">‚úó Rejeitar</button>` : '‚Äî'}
      </td>
    </tr>`).join('');

  document.getElementById('txTable').innerHTML = `
    <table>
      <thead><tr><th>TXID</th><th>Telegram ID</th><th>Valor</th><th>Status</th><th>Data</th><th>A√ß√µes</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">Nenhuma transa√ß√£o encontrada</td></tr>'}</tbody>
    </table>`;

  renderPagination('txPagination', d.page, d.pages, (p) => { txPage = p; loadTransactions(); });
}

async function approveTransaction(txid) {
  await api('approve', { method: 'POST', body: { txid } });
  toast('‚úÖ Transa√ß√£o aprovada!', 'success');
  loadTransactions();
}
async function rejectTransaction(txid) {
  await api('reject', { method: 'POST', body: { txid } });
  toast('‚ùå Transa√ß√£o rejeitada.', 'error');
  loadTransactions();
}

// ===== FALHAS =====
async function loadFailures() {
  const d = await api('deliveryFailures');
  if (!d.data?.length) {
    document.getElementById('failuresTable').innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Nenhuma falha de entrega!</div></div>';
    return;
  }
  const rows = d.data.map(f => `
    <tr>
      <td><span class="mono">${f.txid?.substring(0,16)}...</span></td>
      <td><span class="mono">${f.telegram_id}</span></td>
      <td><strong>R$ ${fmt(f.amount)}</strong></td>
      <td>${badge(f.delivery_error_type || 'unknown')}</td>
      <td style="font-size:12px;color:var(--muted)">${f.delivery_attempts}x tentativas</td>
      <td style="font-size:11px;color:var(--muted)">${fmtDate(f.last_delivery_attempt_at)}</td>
    </tr>`).join('');
  document.getElementById('failuresTable').innerHTML = `
    <table>
      <thead><tr><th>TXID</th><th>Telegram ID</th><th>Valor</th><th>Tipo Erro</th><th>Tentativas</th><th>√öltima Tentativa</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

// ===== PRODUTOS =====
async function loadProducts() {
  const d = await api('products');
  if (!d.data?.length) {
    document.getElementById('productsTable').innerHTML = '<div class="empty-state"><div class="empty-icon">üõçÔ∏è</div><div>Nenhum produto cadastrado</div></div>';
    return;
  }
  const rows = d.data.map(p => `
    <tr>
      <td><strong>${p.name}</strong></td>
      <td><span class="mono">${p.product_id}</span></td>
      <td><strong style="color:var(--accent)">R$ ${fmt(p.price)}</strong></td>
      <td>${p.delivery_type}</td>
      <td>${p.is_active ? '<span class="badge badge-delivered">Ativo</span>' : '<span class="badge badge-rejected">Inativo</span>'}</td>
      <td style="color:var(--muted);font-size:11px">${fmtDate(p.created_at)}</td>
    </tr>`).join('');
  document.getElementById('productsTable').innerHTML = `
    <table>
      <thead><tr><th>Nome</th><th>ID</th><th>Pre√ßo</th><th>Tipo</th><th>Status</th><th>Criado</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function openProductModal() { document.getElementById('modalProduct').classList.add('show'); }
async function saveProduct() {
  const body = { product_id: document.getElementById('p_id').value, name: document.getElementById('p_name').value, description: document.getElementById('p_desc').value, price: document.getElementById('p_price').value, delivery_type: document.getElementById('p_type').value, delivery_url: document.getElementById('p_url').value };
  const d = await api('createProduct', { method: 'POST', body });
  if (d.ok) { toast('‚úÖ Produto criado!', 'success'); closeModal('modalProduct'); loadProducts(); }
  else toast('‚ùå ' + (d.error || 'Erro'), 'error');
}

// ===== GRUPOS =====
async function loadGroups() {
  const d = await api('groups');
  if (!d.data?.length) {
    document.getElementById('groupsTable').innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div>Nenhum grupo cadastrado</div></div>';
    return;
  }
  const rows = d.data.map(g => `
    <tr>
      <td><strong>${g.group_name}</strong></td>
      <td><span class="mono">${g.group_id}</span></td>
      <td><strong style="color:var(--accent)">R$ ${fmt(g.subscription_price)}</strong></td>
      <td style="color:var(--text2)">${g.subscription_days} dias</td>
      <td>${g.is_active ? '<span class="badge badge-delivered">Ativo</span>' : '<span class="badge badge-rejected">Inativo</span>'}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="toggleGroup('${g.group_id}', ${!g.is_active})">${g.is_active ? '‚è∏ Pausar' : '‚ñ∂ Ativar'}</button>
      </td>
    </tr>`).join('');
  document.getElementById('groupsTable').innerHTML = `
    <table>
      <thead><tr><th>Nome</th><th>ID</th><th>Pre√ßo</th><th>Dura√ß√£o</th><th>Status</th><th>A√ß√µes</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

async function toggleGroup(id, active) {
  await api('toggleGroup', { method: 'POST', body: { group_id: id, active } });
  toast(active ? '‚úÖ Grupo ativado!' : '‚è∏ Grupo pausado.', 'success');
  loadGroups();
}

// ===== USU√ÅRIOS =====
async function loadUsers() {
  document.getElementById('usersTable').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  const search = document.getElementById('userSearch')?.value || '';
  const blocked = document.getElementById('userBlocked')?.value || '';
  const d = await api('users', { params: { page: usersPage, limit: 25, search, blocked } });
  if (!d.data) return;

  const rows = d.data.map(u => `
    <tr>
      <td><strong>${u.first_name || 'N/A'} ${u.last_name || ''}</strong></td>
      <td><span class="mono">@${u.username || '‚Äî'}</span></td>
      <td><span class="mono">${u.telegram_id}</span></td>
      <td>${u.is_blocked ? '<span class="badge badge-blocked">Bloqueado</span>' : '<span class="badge badge-active">Ativo</span>'}${u.is_admin ? ' <span class="badge badge-sending">Admin</span>' : ''}${u.is_creator ? ' <span class="badge badge-approved">Criador</span>' : ''}</td>
      <td style="color:var(--muted);font-size:11px">${fmtDate(u.created_at)}</td>
      <td>
        <button class="btn btn-sm ${u.is_blocked ? 'btn-success' : 'btn-danger'}" onclick="toggleBlock(${u.telegram_id}, ${!u.is_blocked})">
          ${u.is_blocked ? 'üîì Desbloquear' : 'üîí Bloquear'}
        </button>
      </td>
    </tr>`).join('');

  document.getElementById('usersTable').innerHTML = `
    <table>
      <thead><tr><th>Nome</th><th>Username</th><th>Telegram ID</th><th>Status</th><th>Cadastro</th><th>A√ß√µes</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">Nenhum usu√°rio encontrado</td></tr>'}</tbody>
    </table>`;

  renderPagination('usersPagination', d.page, d.pages, (p) => { usersPage = p; loadUsers(); });
}

async function toggleBlock(telegram_id, block) {
  await api('toggleBlock', { method: 'POST', body: { telegram_id, block } });
  toast(block ? 'üîí Usu√°rio bloqueado.' : 'üîì Usu√°rio desbloqueado!', block ? 'error' : 'success');
  loadUsers();
}

// ===== TICKETS =====
async function loadTickets() {
  document.getElementById('ticketsTable').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  const status = document.getElementById('ticketStatus')?.value || 'all';
  const d = await api('tickets', { params: { page: ticketsPage, limit: 20, status } });
  if (!d.data) return;

  const rows = d.data.map(t => `
    <tr>
      <td><strong>#${t.ticket_number || t.id?.substring(0,8)}</strong></td>
      <td>${t.user?.first_name || 'N/A'} <span class="mono" style="font-size:11px;color:var(--muted)">@${t.user?.username || t.user?.telegram_id || ''}</span></td>
      <td>${t.subject || '‚Äî'}</td>
      <td>${badge(t.status)}</td>
      <td style="color:var(--muted);font-size:11px">${fmtDate(t.created_at)}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="viewTicket('${t.id}', '${t.subject || 'Ticket'}', '${t.status}')">üëÅ Ver</button>
        ${t.status !== 'resolved' ? `<button class="btn btn-success btn-sm" onclick="closeTicket('${t.id}')">‚úì Resolver</button>` : ''}
      </td>
    </tr>`).join('');

  document.getElementById('ticketsTable').innerHTML = `
    <table>
      <thead><tr><th>#</th><th>Usu√°rio</th><th>Assunto</th><th>Status</th><th>Data</th><th>A√ß√µes</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">Nenhum ticket</td></tr>'}</tbody>
    </table>`;

  renderPagination('ticketsPagination', d.page, d.pages, (p) => { ticketsPage = p; loadTickets(); });
}

async function viewTicket(id, subject, status) {
  document.getElementById('ticketModalTitle').textContent = `üé´ ${subject}`;
  document.getElementById('ticketMessages').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  document.getElementById('btnCloseTicket').onclick = () => closeTicket(id);
  document.getElementById('btnCloseTicket').style.display = status === 'resolved' ? 'none' : 'flex';
  document.getElementById('modalTicket').classList.add('show');

  const d = await api('ticketMessages', { params: { ticket_id: id } });
  const msgs = d.data?.map(m => `
    <div class="ticket-msg ${m.is_admin ? 'admin' : 'user'}">
      <div>${m.message}</div>
      <div class="ticket-msg-meta">${m.is_admin ? 'üëë Admin' : 'üë§ Usu√°rio'} ‚Ä¢ ${fmtDate(m.created_at)}</div>
    </div>`).join('') || '<div style="text-align:center;color:var(--muted);padding:20px">Nenhuma mensagem</div>';
  document.getElementById('ticketMessages').innerHTML = msgs;
}

async function closeTicket(id) {
  await api('closeTicket', { method: 'POST', body: { ticket_id: id } });
  toast('‚úÖ Ticket resolvido!', 'success');
  closeModal('modalTicket');
  loadTickets();
}

// ===== BROADCAST =====
async function loadBroadcast() {
  const d = await api('broadcasts');
  if (!d.data?.length) {
    document.getElementById('broadcastList').innerHTML = '<div class="empty-state"><div class="empty-icon">üì¢</div><div>Nenhuma campanha criada ainda</div></div>';
    return;
  }
  document.getElementById('broadcastList').innerHTML = d.data.map(c => {
    const pct = c.total_users > 0 ? Math.round(((c.success_count||0) + (c.failed_count||0)) / c.total_users * 100) : 0;
    return `
    <div class="broadcast-card">
      <div style="font-size:32px">${c.status === 'sent' ? '‚úÖ' : c.status === 'sending' || c.status === 'pending' ? 'üì°' : '‚ö†Ô∏è'}</div>
      <div class="broadcast-progress">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">${c.name}</div>
          ${badge(c.status)}
        </div>
        <div style="font-size:12px;color:var(--text2);margin-top:4px">
          ‚úÖ ${c.success_count||0} enviados &nbsp; ‚ùå ${c.failed_count||0} falhas &nbsp; üë• ${c.total_users||'?'} total
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${fmtDate(c.created_at)} &nbsp;‚Ä¢&nbsp; ${pct}% conclu√≠do</div>
      </div>
    </div>`;
  }).join('');
}

// ===== SETTINGS =====
async function loadSettings() {
  const d = await api('pixKey');
  document.getElementById('pixKeyInput').value = d.pixKey || '';
}
async function savePixKey() {
  const pixKey = document.getElementById('pixKeyInput').value.trim();
  if (!pixKey) return toast('‚ùå Chave PIX n√£o pode ser vazia', 'error');
  await api('setPixKey', { method: 'POST', body: { pixKey } });
  toast('‚úÖ Chave PIX salva!', 'success');
}

// ===== STATS =====
async function loadStats() {
  const d = await api('stats');

  // Vendas por dia ‚Äî mini chart de barras em CSS
  const byDay = d.byDay || {};
  const days = Object.keys(byDay).sort().slice(-14);
  const maxVal = Math.max(...days.map(k => byDay[k]), 1);
  const chartHtml = `
    <div style="display:flex;align-items:flex-end;gap:4px;height:80px;padding:8px 0">
      ${days.map(k => `
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
          <div style="width:100%;background:var(--accent);border-radius:3px 3px 0 0;opacity:.8;height:${Math.max(4, (byDay[k]/maxVal)*70)}px" title="R$ ${fmt(byDay[k])}"></div>
          <div style="font-size:9px;color:var(--muted);transform:rotate(-45deg);transform-origin:top right">${k.slice(5)}</div>
        </div>`).join('')}
    </div>
    <div style="font-size:12px;color:var(--text2);margin-top:8px">Total 14 dias: <strong style="color:var(--accent)">R$ ${fmt(days.reduce((a,k)=>a+(byDay[k]||0),0))}</strong></div>`;
  document.getElementById('chartByDay').innerHTML = chartHtml;

  // Status
  const byStatus = d.byStatus || {};
  const statusColors = { pending: 'var(--warning)', approved: 'var(--info)', delivered: 'var(--success)', rejected: 'var(--danger)', delivery_failed: 'var(--danger)' };
  const statusHtml = Object.entries(byStatus).map(([s, c]) => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:8px"><div style="width:8px;height:8px;border-radius:50%;background:${statusColors[s]||'var(--muted)'}"></div>${badge(s)}</div>
      <span class="mono" style="color:var(--text)">${c}</span>
    </div>`).join('');
  document.getElementById('chartByStatus').innerHTML = statusHtml || '<div style="color:var(--muted);font-size:13px">Sem dados</div>';
}

// ===== HELPERS =====
function badge(status) {
  const map = { pending:'badge-pending pending', approved:'badge-approved approved', delivered:'badge-delivered delivered', rejected:'badge-rejected rejected', delivery_failed:'badge-failed failed', sending:'badge-sending enviando', pending_broadcast:'badge-sending pendente', sent:'badge-delivered conclu√≠do', open:'badge-open aberto', resolved:'badge-resolved resolvido', closed:'badge-resolved fechado', unknown:'badge-failed desconhecido', blocked:'badge-blocked bloqueado', temporary:'badge-warning tempor√°rio' };
  const cls = map[status] || 'badge-pending';
  const parts = cls.split(' ');
  return `<span class="badge ${parts[0]}">${parts[1] || status}</span>`;
}
function fmt(v) { return parseFloat(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtDate(d) { if (!d) return '‚Äî'; return new Date(d).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}); }

function renderPagination(containerId, current, total, cb) {
  if (!total || total <= 1) { document.getElementById(containerId).innerHTML = ''; return; }
  let html = `<button class="page-btn" onclick="(${cb.toString()})(${Math.max(1,current-1)})" ${current<=1?'disabled':''}>‚Üê</button>`;
  for (let i = Math.max(1,current-2); i <= Math.min(total,current+2); i++) {
    html += `<button class="page-btn ${i===current?'active':''}" onclick="(${cb.toString()})(${i})">${i}</button>`;
  }
  html += `<button class="page-btn" onclick="(${cb.toString()})(${Math.min(total,current+1)})" ${current>=total?'disabled':''}>‚Üí</button>`;
  html += `<span class="page-info">P√°g ${current}/${total}</span>`;
  document.getElementById(containerId).innerHTML = html;
}

function toast(msg, type = 'success') {
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.innerHTML = msg;
  document.getElementById('toastContainer').appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); }));

// ===== INIT =====
checkAuth().then(() => loadDashboard());

// Auto-refresh dashboard a cada 60s
setInterval(() => {
  const active = document.querySelector('.section.active');
  if (active?.id === 'section-dashboard') loadDashboard();
}, 60000);
</script>
</body>
</html>
