## üöÄ CONFIGURA√á√ÉO COMPLETA - AUTOMA√á√ÉO DE EXPIRA√á√ÉO

### üìã PASSO A PASSO COMPLETO

---

## ‚úÖ ETAPA 1: CONFIGURAR CRON_SECRET NA VERCEL

### 1Ô∏è‚É£ Acesse as Vari√°veis de Ambiente:
```
https://vercel.com/nomadepj/api-pix-telegran/settings/environment-variables
```

### 2Ô∏è‚É£ Clique em "Add New"

### 3Ô∏è‚É£ Preencha EXATAMENTE assim:

```
Name: CRON_SECRET
Value: OKOe9AdRCaUjgvdXDbgSbV5bKnG8NdCkWYEfITRh34A=
```

### 4Ô∏è‚É£ Selecione os 3 ambientes:
- ‚úÖ Production
- ‚úÖ Preview  
- ‚úÖ Development

### 5Ô∏è‚É£ Clique em "Save"

### 6Ô∏è‚É£ **IMPORTANTE:** V√° para "Deployments" e clique em "Redeploy"
```
https://vercel.com/nomadepj/api-pix-telegran/deployments
```

### 7Ô∏è‚É£ Aguarde 1-2 minutos at√© aparecer ‚úÖ "Ready"

---

## ‚úÖ ETAPA 2: CRIAR CONTA NO CRON-JOB.ORG

### 1Ô∏è‚É£ Acesse:
```
https://cron-job.org/en/signup/
```

### 2Ô∏è‚É£ Preencha:
- Email: (seu email)
- Password: (crie uma senha)
- Confirme o email

### 3Ô∏è‚É£ Fa√ßa login

---

## ‚úÖ ETAPA 3: CONFIGURAR O CRON JOB

### 1Ô∏è‚É£ Clique em "Create cronjob"

### 2Ô∏è‚É£ Preencha EXATAMENTE:

**ABA "General":**
```
Title: Verificar Expira√ß√µes de Membros
```

**URL:**
```
https://api-pix-telegran.vercel.app/api/jobs/expire-members
```

**ABA "Schedule":**
```
‚òëÔ∏è Every 30 minutes
```

Ou configure manualmente:
```
Minutes: */30
Hours: *
Days: *
Months: *
Days of week: *
```

**ABA "Advanced":**

Request Method:
```
POST
```

Request Headers:
```
x-cron-secret: OKOe9AdRCaUjgvdXDbgSbV5bKnG8NdCkWYEfITRh34A=
```

Para adicionar o header:
1. Clique em "Add header"
2. Name: `x-cron-secret`
3. Value: `OKOe9AdRCaUjgvdXDbgSbV5bKnG8NdCkWYEfITRh34A=`

**ABA "Notifications":**
```
‚òëÔ∏è On failure only (opcional - para receber email se falhar)
```

### 3Ô∏è‚É£ Clique em "Create"

### 4Ô∏è‚É£ **TESTAR IMEDIATAMENTE:**

Na lista de cron jobs, clique nos 3 pontinhos (...) ‚Üí "Run now"

---

## ‚úÖ ETAPA 4: VALIDAR QUE EST√Å FUNCIONANDO

### 1Ô∏è‚É£ Ap√≥s clicar em "Run now", aguarde 30 segundos

### 2Ô∏è‚É£ Clique no job ‚Üí "History" para ver o resultado

Deve aparecer:
```
Status: 200 OK
Response: {"success":true,...}
```

### 3Ô∏è‚É£ **IMPORTANTE:** Verifique no Supabase

Execute esta query:
```sql
-- Deve retornar 0
SELECT COUNT(*) FROM group_members
WHERE status = 'active' AND expires_at < NOW() - INTERVAL '1 day';
```

### 4Ô∏è‚É£ Verifique logs na Vercel (opcional):
```
https://vercel.com/nomadepj/api-pix-telegran/logs
```

Procure por: `[CRON-EXPIRE] Job de expira√ß√£o iniciado`

---

## ‚úÖ ETAPA 5: CONFIGURA√á√ÉO FINAL (OPCIONAL MAS RECOMENDADO)

### Adicionar notifica√ß√µes de erro no cron-job.org:

1. V√° em Settings ‚Üí Notification Settings
2. Ative "Email notifications"
3. Selecione "On failure only"

Assim voc√™ recebe email se o cron falhar.

---

## üìä O QUE VAI ACONTECER AUTOMATICAMENTE:

### **A CADA 30 MINUTOS:**

1. Cron-job.org chama o endpoint na Vercel
2. Sistema verifica todos os membros de grupos
3. **3 dias antes do vencimento:**
   - Envia lembrete com QR Code (v√°lido 7 dias)
   - Link do grupo inclu√≠do
4. **No dia do vencimento:**
   - Envia lembrete URGENTE com QR Code
   - "EXPIRA EM X HORAS"
5. **1 dia ap√≥s vencer (SEM pagamento):**
   - Remove do grupo Telegram
   - Marca como expired no banco
   - Envia QR Code de renova√ß√£o (v√°lido 30 min)
6. **Se usu√°rio pagar:**
   - Admin aprova
   - Sistema renova automaticamente (+30 dias)
   - Adiciona de volta ao grupo
   - Envia link de acesso

---

## üîç COMO MONITORAR:

### No Cron-Job.org:
- Dashboard ‚Üí Seu job ‚Üí "History"
- Veja todas as execu√ß√µes e status

### Na Vercel:
- Logs ‚Üí Filtrar por "CRON-EXPIRE"
- Ver processamentos em tempo real

### No Supabase:
```sql
-- Quantos est√£o para vencer (pr√≥ximos 3 dias)
SELECT COUNT(*) FROM group_members
WHERE status = 'active' 
  AND expires_at BETWEEN NOW() AND NOW() + INTERVAL '3 days';

-- Quantos venceram e aguardam remo√ß√£o
SELECT COUNT(*) FROM group_members
WHERE status = 'active' 
  AND expires_at < NOW() - INTERVAL '1 day';

-- √öltimas expira√ß√µes
SELECT telegram_id, expires_at, status, updated_at
FROM group_members
WHERE status = 'expired'
ORDER BY updated_at DESC
LIMIT 10;
```

---

## ‚ö†Ô∏è POSS√çVEIS PROBLEMAS E SOLU√á√ïES:

### ‚ùå Erro 401 - Unauthorized
**Causa:** CRON_SECRET errado ou n√£o configurado
**Solu√ß√£o:**
1. Verifique se `CRON_SECRET` est√° na Vercel
2. Confirme que fez Redeploy
3. Verifique se o header no cron-job.org est√° correto

### ‚ùå Erro 500 - Internal Server Error
**Causa:** Bot sem permiss√µes ou erro no c√≥digo
**Solu√ß√£o:**
1. Verifique logs na Vercel
2. Confirme que bot √© administrador do grupo
3. Confirme permiss√£o "Banir usu√°rios"

### ‚ùå Timeout / Sem resposta
**Causa:** Endpoint demorando muito (muitos usu√°rios)
**Solu√ß√£o:** Normal para muitos usu√°rios, aguarde at√© 60 segundos

### ‚ùå Usu√°rios n√£o sendo removidos
**Causa:** Bot n√£o √© admin do grupo
**Solu√ß√£o:**
1. Abra o grupo no Telegram
2. Clique no nome ‚Üí Editar
3. Administradores ‚Üí Adicionar
4. Selecione o bot
5. Ative "Banir usu√°rios"

---

## ‚úÖ CHECKLIST FINAL:

- [ ] ADMIN_SECRET configurado na Vercel (j√° feito ‚úÖ)
- [ ] CRON_SECRET configurado na Vercel
- [ ] Redeploy feito na Vercel
- [ ] Conta criada no cron-job.org
- [ ] Cron job configurado (30 minutos)
- [ ] Header x-cron-secret adicionado
- [ ] Teste manual executado ("Run now")
- [ ] Status 200 OK recebido
- [ ] Query SQL retorna 0 expirados
- [ ] Bot √© admin do grupo
- [ ] Bot tem permiss√£o "Banir usu√°rios"

---

## üéØ RESUMO DOS COMANDOS:

### Testar manualmente na Vercel:
```powershell
$headers = @{ "x-cron-secret" = "OKOe9AdRCaUjgvdXDbgSbV5bKnG8NdCkWYEfITRh34A=" }
Invoke-WebRequest -Uri "https://api-pix-telegran.vercel.app/api/jobs/expire-members" -Method POST -Headers $headers | Select-Object -ExpandProperty Content
```

### Ver status no banco:
```sql
SELECT COUNT(*) FROM group_members
WHERE status = 'active' AND expires_at < NOW() - INTERVAL '1 day';
```

---

## üéâ PRONTO!

Ap√≥s seguir todos os passos:
- ‚úÖ Sistema roda automaticamente a cada 30 minutos
- ‚úÖ Lembretes enviados automaticamente
- ‚úÖ Remo√ß√µes autom√°ticas
- ‚úÖ Renova√ß√µes autom√°ticas
- ‚úÖ Zero manuten√ß√£o necess√°ria

**SISTEMA 100% AUTOM√ÅTICO!** üöÄ
